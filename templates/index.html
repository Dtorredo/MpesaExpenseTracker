<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mpesa Tracker Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
  <style>
    .chart-container { 
      display: none; 
      height: 400px;
      position: relative;
    }
    .chart-container.active { 
      display: block; 
    }
    .chart-container canvas {
      max-height: 350px !important;
    }
  </style>
</head>
<body class="bg-white text-gray-900 min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <h2 class="text-3xl font-bold text-green-600 mb-6 text-center">ðŸ“Š Mpesa Tracker Dashboard</h2>

    <div id="noDataNotice" class="text-center text-gray-500 mb-6">
      <p class="text-lg">ðŸ“‚ No data loaded. Please upload an Mpesa statement to view the dashboard.</p>
    </div>

    <!-- Filters -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 hidden" id="filterSection">
      <div>
        <label for="daterange" class="block mb-2 text-sm font-medium text-green-600">Date Range</label>
        <input id="daterange" type="text" placeholder="Select range" class="w-full rounded-md p-2 border border-green-500"/>
      </div>
      <div>
        <label for="chartType" class="block mb-2 text-sm font-medium text-green-600">Chart Type</label>
        <select id="chartType" class="w-full rounded-md p-2 border border-green-500">
          <option value="line">ðŸ“ˆ Line</option>
          <option value="bar">ðŸ“Š Bar</option>
          <option value="pie">ðŸ¥§ Pie</option>
          <option value="polarArea">ðŸŽ¯ Polar Area</option>
        </select>
      </div>
      <div>
        <label for="aggregation" class="block mb-2 text-sm font-medium text-green-600">Aggregation</label>
        <select id="aggregation" class="w-full rounded-md p-2 border border-green-500">
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
        </select>
      </div>
      <div>
        <label for="txnType" class="block mb-2 text-sm font-medium text-green-600">Transaction Type</label>
        <select id="txnType" class="w-full rounded-md p-2 border border-green-500">
          <option value="all">All</option>
          <option value="PayBill">M-PESA PayBill</option>
          <option value="P2P">P2P</option>
          <option value="Airtime">Airtime</option>
        </select>
      </div>
      <div class="flex items-center">
        <label class="flex items-center gap-2 text-sm font-medium text-green-600">
          <input type="checkbox" id="compareMode" class="accent-green-600"/>
          Compare Mode
        </label>
      </div>
      <div class="flex items-end">
        <button onclick="loadChart()" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded shadow-md transition-transform transform hover:scale-105">
          ðŸš€ Apply
        </button>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-4 mb-6 hidden" id="actionButtons">
      <button onclick="showTypeBreakdown()" class="bg-yellow-400 hover:bg-yellow-500 text-white font-semibold py-2 px-4 rounded shadow-md">
        ðŸ“Š Type Breakdown
      </button>
      <button onclick="generateSampleData()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded shadow-md">
        ðŸŽ² Generate Sample Data
      </button>
    </div>

    <!-- Chart containers -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="chartsWrapper">
      <div id="lineChartContainer" class="chart-container">
        <h3 class="text-xl font-semibold text-green-600 mb-4 text-center">Line Chart</h3>
        <canvas id="lineChart"></canvas>
      </div>
      <div id="barChartContainer" class="chart-container">
        <h3 class="text-xl font-semibold text-green-600 mb-4 text-center">Bar Chart</h3>
        <canvas id="barChart"></canvas>
      </div>
      <div id="pieChartContainer" class="chart-container">
        <h3 class="text-xl font-semibold text-green-600 mb-4 text-center">Pie Chart</h3>
        <canvas id="pieChart"></canvas>
      </div>
      <div id="polarAreaChartContainer" class="chart-container">
        <h3 class="text-xl font-semibold text-green-600 mb-4 text-center">Polar Area Chart</h3>
        <canvas id="polarAreaChart"></canvas>
      </div>
      <div id="comparisonChartContainer" class="chart-container">
        <h3 class="text-xl font-semibold text-green-600 mb-4 text-center">Comparison Chart</h3>
        <canvas id="comparisonChart"></canvas>
      </div>
      <div id="typeBreakdownContainer" class="chart-container">
        <h3 class="text-xl font-semibold text-green-600 mb-4 text-center">Transaction Type Breakdown</h3>
        <canvas id="typeBreakdownChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-white border border-gray-300 shadow-md px-6 py-3 rounded-full flex gap-8">
    <a href="/" class="text-center text-green-600 hover:text-green-800">
      <i class="fas fa-home"></i><br/><small>Home</small>
    </a>
    <a href="/upload" class="text-center text-green-600 hover:text-green-800">
      <i class="fa-solid fa-cloud-arrow-up"></i><br/><small>Upload</small>
    </a>
  </footer>

  <script>
    let rawData = null;
    let lineChart, barChart, pieChart, polarAreaChart, comparisonChart, typeBreakdownChart;

    // Initialize flatpickr
    flatpickr("#daterange", {
      mode: "range",
      dateFormat: "Y-m-d"
    });

    function showChart(type, isCompare) {
      document.querySelectorAll('.chart-container').forEach(div => div.classList.remove('active'));
      if (isCompare) {
        document.getElementById("comparisonChartContainer").classList.add('active');
      } else {
        document.getElementById(`${type}ChartContainer`).classList.add('active');
      }
    }

    function cumulativeSum(arr) {
      const result = [];
      let accumulator = 0;
      for (let i = 0; i < arr.length; i++) {
        accumulator += arr[i];
        result.push(accumulator);
      }
      return result;
    }

    function groupData(data, mode) {
      const grouped = {};
      for (let i = 0; i < data.dates.length; i++) {
        const date = new Date(data.dates[i]);
        let key = data.dates[i];
        
        if (mode === "weekly") {
          const firstDay = new Date(date.getFullYear(), date.getMonth(), date.getDate() - date.getDay());
          key = firstDay.toISOString().split('T')[0];
        } else if (mode === "monthly") {
          key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        }
        
        if (!grouped[key]) {
          grouped[key] = { income: 0, expenses: 0 };
        }
        grouped[key].income += data.income[i] || 0;
        grouped[key].expenses += data.expenses[i] || 0;
      }
      
      const labels = Object.keys(grouped).sort();
      const income = labels.map(label => grouped[label].income);
      const expenses = labels.map(label => grouped[label].expenses);
      return { labels, income, expenses };
    }

    function filterDataByType(data, txnFilter) {
      const filtered = { dates: [], income: [], expenses: [], types: [] };
      
      for (let i = 0; i < data.dates.length; i++) {
        const type = data.types?.[i] || "Other";
        
        if (txnFilter === "all" || type === txnFilter) {
          filtered.dates.push(data.dates[i]);
          filtered.income.push(data.income[i] || 0);
          filtered.expenses.push(data.expenses[i] || 0);
          filtered.types.push(type);
        }
      }
      
      return filtered;
    }

    function filterDataByDateRange(data, startDate, endDate) {
      const filtered = { dates: [], income: [], expenses: [], types: [] };
      
      for (let i = 0; i < data.dates.length; i++) {
        const date = data.dates[i];
        const inDateRange = !startDate || (date >= startDate && date <= endDate);
        
        if (inDateRange) {
          filtered.dates.push(date);
          filtered.income.push(data.income[i] || 0);
          filtered.expenses.push(data.expenses[i] || 0);
          filtered.types.push(data.types?.[i] || "Other");
        }
      }
      
      return filtered;
    }

    function destroyCharts() {
      if (lineChart) { lineChart.destroy(); lineChart = null; }
      if (barChart) { barChart.destroy(); barChart = null; }
      if (pieChart) { pieChart.destroy(); pieChart = null; }
      if (polarAreaChart) { polarAreaChart.destroy(); polarAreaChart = null; }
      if (comparisonChart) { comparisonChart.destroy(); comparisonChart = null; }
      if (typeBreakdownChart) { typeBreakdownChart.destroy(); typeBreakdownChart = null; }
    }

    // Add resize handling
    function handleResize() {
      const charts = [lineChart, barChart, pieChart, polarAreaChart, comparisonChart, typeBreakdownChart];
      charts.forEach(chart => {
        if (chart) {
          chart.resize();
        }
      });
    }

    // Debounced resize handler
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(handleResize, 100);
    });

    function loadChart() {
      const stored = sessionStorage.getItem("mpesaData");
      if (!stored) {
        document.getElementById("noDataNotice").style.display = "block";
        document.getElementById("filterSection").classList.add("hidden");
        document.getElementById("actionButtons").classList.add("hidden");
        return;
      }
      
      document.getElementById("noDataNotice").style.display = "none";
      document.getElementById("filterSection").classList.remove("hidden");
      document.getElementById("actionButtons").classList.remove("hidden");

      rawData = JSON.parse(stored);

      const dateRangeValue = document.getElementById("daterange").value;
      const [startDate, endDate] = dateRangeValue.includes(" to ") ? dateRangeValue.split(" to ") : [null, null];
      const aggregation = document.getElementById("aggregation").value;
      const chartType = document.getElementById("chartType").value;
      const txnFilter = document.getElementById("txnType").value;
      const isCompare = document.getElementById("compareMode").checked;

      // Filter data by date range first
      let filteredData = filterDataByDateRange(rawData, startDate, endDate);
      
      // Then filter by transaction type
      filteredData = filterDataByType(filteredData, txnFilter);

      if (filteredData.dates.length === 0) {
        alert("No data found for the selected filters.");
        return;
      }

      const grouped = groupData(filteredData, aggregation);
      const balance = cumulativeSum(grouped.income.map((v, i) => v - grouped.expenses[i]));

      showChart(chartType, isCompare);
      destroyCharts();

      if (isCompare) {
        // For comparison, show filtered vs all data
        const allData = filterDataByDateRange(rawData, startDate, endDate);
        const allGrouped = groupData(allData, aggregation);
        
        comparisonChart = new Chart(document.getElementById("comparisonChart"), {
          type: (chartType === "pie" || chartType === "polarArea") ? "bar" : chartType,
          data: {
            labels: grouped.labels,
            datasets: [
              { 
                label: `${txnFilter} Income`, 
                data: grouped.income, 
                backgroundColor: "#10B981", 
                borderColor: "#10B981", 
                fill: false 
              },
              { 
                label: `All Income`, 
                data: allGrouped.income, 
                backgroundColor: "#FBBF24", 
                borderColor: "#FBBF24", 
                fill: false 
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              tooltip: { enabled: true }, 
              legend: { labels: { color: "black" } } 
            },
            scales: { 
              x: { ticks: { color: 'black' } }, 
              y: { ticks: { color: 'black' } } 
            }
          }
        });
        return;
      }

      if (chartType === "line") {
        lineChart = new Chart(document.getElementById("lineChart"), {
          type: 'line',
          data: {
            labels: grouped.labels,
            datasets: [
              { 
                label: "Income", 
                data: grouped.income, 
                borderColor: "#10B981", 
                backgroundColor: "rgba(16, 185, 129, 0.1)", 
                tension: 0.3 
              },
              { 
                label: "Expenses", 
                data: grouped.expenses, 
                borderColor: "#EF4444", 
                backgroundColor: "rgba(239, 68, 68, 0.1)", 
                tension: 0.3 
              },
              { 
                label: "Running Balance", 
                data: balance, 
                borderColor: "#3B82F6", 
                backgroundColor: "rgba(59, 130, 246, 0.1)", 
                tension: 0.3 
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              tooltip: { enabled: true }, 
              legend: { labels: { color: "black" } } 
            },
            scales: { 
              x: { ticks: { color: 'black' } }, 
              y: { ticks: { color: 'black' } } 
            }
          }
        });
      }

      if (chartType === "bar") {
        barChart = new Chart(document.getElementById("barChart"), {
          type: 'bar',
          data: {
            labels: grouped.labels,
            datasets: [
              { label: "Income", data: grouped.income, backgroundColor: "#10B981" },
              { label: "Expenses", data: grouped.expenses, backgroundColor: "#EF4444" },
              { label: "Running Balance", data: balance, backgroundColor: "#3B82F6" }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              tooltip: { enabled: true }, 
              legend: { labels: { color: "black" } } 
            },
            scales: { 
              x: { ticks: { color: 'black' } }, 
              y: { ticks: { color: 'black' } } 
            }
          }
        });
      }

      if (chartType === "pie") {
        const totalIncome = grouped.income.reduce((a, b) => a + b, 0);
        const totalExpenses = grouped.expenses.reduce((a, b) => a + b, 0);
        const finalBalance = balance[balance.length - 1] || 0;
        
        pieChart = new Chart(document.getElementById("pieChart"), {
          type: 'pie',
          data: {
            labels: ["Income", "Expenses", "Net Balance"],
            datasets: [{
              data: [totalIncome, totalExpenses, Math.abs(finalBalance)],
              backgroundColor: ["#10B981", "#EF4444", "#3B82F6"]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              tooltip: { enabled: true }, 
              legend: { labels: { color: "black" } } 
            }
          }
        });
      }

      if (chartType === "polarArea") {
        const totalIncome = grouped.income.reduce((a, b) => a + b, 0);
        const totalExpenses = grouped.expenses.reduce((a, b) => a + b, 0);
        const finalBalance = balance[balance.length - 1] || 0;
        
        polarAreaChart = new Chart(document.getElementById("polarAreaChart"), {
          type: 'polarArea',
          data: {
            labels: ["Income", "Expenses", "Net Balance"],
            datasets: [{
              data: [totalIncome, totalExpenses, Math.abs(finalBalance)],
              backgroundColor: [
                "rgba(16, 185, 129, 0.7)",
                "rgba(239, 68, 68, 0.7)",
                "rgba(59, 130, 246, 0.7)"
              ],
              borderColor: ["#10B981", "#EF4444", "#3B82F6"],
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
              tooltip: { enabled: true }, 
              legend: { labels: { color: "black" } } 
            },
            scales: {
              r: {
                ticks: { color: 'black' },
                grid: { color: 'rgba(0, 0, 0, 0.1)' }
              }
            }
          }
        });
      }
    }

    function showTypeBreakdown() {
      const stored = sessionStorage.getItem("mpesaData");
      if (!stored) return;
      
      const raw = JSON.parse(stored);
      const dateRangeValue = document.getElementById("daterange").value;
      const [startDate, endDate] = dateRangeValue.includes(" to ") ? dateRangeValue.split(" to ") : [null, null];

      const typeCounts = {};
      const colorMap = {
        "P2P": "#34D399",
        "PayBill": "#3B82F6",
        "Airtime": "#FBBF24",
        "Charges": "#F87171",
        "Other": "#A78BFA"
      };

      for (let i = 0; i < raw.dates.length; i++) {
        const date = raw.dates[i];
        const type = raw.types?.[i] || "Other";
        const inDateRange = !startDate || (date >= startDate && date <= endDate);
        
        if (inDateRange) {
          typeCounts[type] = (typeCounts[type] || 0) + 1;
        }
      }

      const labels = Object.keys(typeCounts);
      const values = labels.map(label => typeCounts[label]);
      const bgColors = labels.map(label => colorMap[label] || "#D1D5DB");

      destroyCharts();
      
      document.querySelectorAll('.chart-container').forEach(div => div.classList.remove('active'));
      document.getElementById("typeBreakdownContainer").classList.add("active");

      typeBreakdownChart = new Chart(document.getElementById("typeBreakdownChart"), {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: bgColors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: { enabled: true },
            legend: { labels: { color: "black" } }
          }
        }
      });
    }

    function generateSampleData() {
      const sampleData = {
        dates: [
          "2024-01-01", "2024-01-02", "2024-01-03", "2024-01-04", "2024-01-05",
          "2024-01-06", "2024-01-07", "2024-01-08", "2024-01-09", "2024-01-10"
        ],
        income: [5000, 0, 3000, 0, 2000, 0, 4000, 0, 1000, 0],
        expenses: [0, 1500, 0, 800, 0, 1200, 0, 600, 0, 400],
        types: ["P2P", "PayBill", "P2P", "Airtime", "P2P", "PayBill", "P2P", "Charges", "P2P", "Other"]
      };
      
      sessionStorage.setItem("mpesaData", JSON.stringify(sampleData));
      alert("Sample data generated! You can now use the dashboard.");
      loadChart();
    }

    // Initialize the dashboard
    if (sessionStorage.getItem("mpesaData")) {
      loadChart();
    }
  </script>
  <script src="https://kit.fontawesome.com/d08ab046b6.js" crossorigin="anonymous"></script>
</body>
</html>